name: Backend CI
concurrency: 
  group: backend-${{ github.head_ref }}
  cancel-in-progress: true
on:
  push:
    branches:
      - 'develop'
  pull_request_target:
    paths-ignore:
      - 'docs/**'
  workflow_dispatch:
jobs:
  lint_backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2.4.0
    - name: Rubocop checks
      uses: luizfonseca/github-actions-rubocop@1.5.6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  test_backend:
    runs-on: ubuntu-latest
    steps:
      - name: Test
        run: bundle exec rspec -f j -o tmp/rspec_results.json -f p
      - name: RSpec Report
        uses: SonicGarden/rspec-report-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          json-path: tmp/rspec_results.json
        if: always()
  # TODO: Parse error was fixed in Brakeman 5.1.2 but 
  # the Github Action is using the docker image
  # which is stuck at 5.1.1 so we need to disable
  # this for now
  # brakeman:
  #   name: Brakeman Static Analysis
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2.4.0
  #       with:
  #         fetch-depth: 2
  #     - run: git checkout HEAD^
  #     - name: Analyze code statically using Brakeman
  #       uses: artplan1/brakeman-action@v1.2.1
  #       with: 
  #         flags: "--color"